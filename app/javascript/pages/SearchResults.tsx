import React, { useState, useEffect, useMemo } from 'react';
import {
  Box,
  Container,
  VStack,
  HStack,
  Text,
  Button,
  SimpleGrid,
  Heading,
  useColorMode,
  Badge,
  Tabs,
  TabList,
  TabPanels,
  Tab,
  TabPanel,
  Input,
  InputGroup,
  InputLeftElement,
  Flex,
  Divider,
} from '@chakra-ui/react';
import { SearchIcon } from '@chakra-ui/icons';
import { useSearchParams, useNavigate } from 'react-router-dom';
import Card from '../components/Card';
import EmptyState from '../components/EmptyState';
import { storyService, loungeService, userService, searchService } from '../services/supabaseDataService';

const SearchResults: React.FC = () => {
  const { colorMode } = useColorMode();
  const [searchParams, setSearchParams] = useSearchParams();
  const navigate = useNavigate();
  const query = searchParams.get('q') || '';
  const [searchInput, setSearchInput] = useState(query);
  const [tabIndex, setTabIndex] = useState(0);
  const [searchResults, setSearchResults] = useState<any>({ stories: [], loungePosts: [], total: 0 });
  const [hotKeywords, setHotKeywords] = useState<any[]>([]);
  const [recentKeywords, setRecentKeywords] = useState<string[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  // Í≤ÄÏÉâ Ïã§Ìñâ Ìï®Ïàò
  const performSearch = async (searchQuery: string) => {
    if (!searchQuery.trim()) {
      setSearchResults({ stories: [], loungePosts: [], total: 0 });
      return;
    }

    try {
      setIsLoading(true);
      console.log('üîç Supabase Í≤ÄÏÉâ Ïã§Ìñâ:', searchQuery);
      
      const results = await searchService.search(searchQuery.trim());
      console.log('‚úÖ Í≤ÄÏÉâ Í≤∞Í≥º:', results);
      
      setSearchResults({
        stories: results.stories || [],
        loungePosts: results.loungePosts || [],
        total: results.totalResults || 0
      });
      
    } catch (error) {
      console.error('‚ùå Í≤ÄÏÉâ Ïã§Ìå®:', error);
      setSearchResults({ stories: [], loungePosts: [], total: 0 });
    } finally {
      setIsLoading(false);
    }
  };

  // Í≤ÄÏÉâ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò  
  const refreshSearchData = async () => {
    try {
      const [topKeywords, recentKeywords] = await Promise.all([
        searchService.getTopKeywords(5),
        searchService.getRecentKeywords(8)
      ]);
      
      setHotKeywords(topKeywords.map((item, index) => ({
        term: item.keyword,
        rank: index + 1,
        count: item.search_count
      })));
      
      setRecentKeywords(recentKeywords.map(item => item.keyword));
      
    } catch (error) {
      console.error('‚ùå Í≤ÄÏÉâ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
      setHotKeywords([]);
      setRecentKeywords([]);
    }
  };
  
  const handleSearch = (newQuery: string) => {
    if (newQuery.trim()) {
      setSearchParams({ q: newQuery.trim() });
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSearch(searchInput);
    }
  };

  // Ï¥àÍ∏∞ Î°úÎìúÏãú Í≤ÄÏÉâ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    refreshSearchData();
  }, []);

  // URL ÌååÎùºÎØ∏ÌÑ∞ Î≥ÄÍ≤ΩÏãú Í≤ÄÏÉâ Ïã§Ìñâ (Ï§ëÎ≥µ Î∞©ÏßÄÎ•º ÏúÑÌï¥ Ìïú Î≤àÎßå)
  useEffect(() => {
    setSearchInput(query);
    if (query.trim()) {
      console.log('üîÑ URL ÌååÎùºÎØ∏ÌÑ∞ Î≥ÄÍ≤ΩÏúºÎ°ú Í≤ÄÏÉâ Ïã§Ìñâ:', query);
      performSearch(query);
    } else {
      setSearchResults({ stories: [], loungePosts: [], total: 0 });
    }
  }, [query]);

  return (
    <Container maxW="1200px" py={{ base: 6, md: 8 }}>
      <VStack spacing={8} align="stretch">
        {/* Í≤ÄÏÉâ Ìó§Îçî */}
        <VStack spacing={4} align="stretch">
          <Heading as="h1" size="xl" color={colorMode === 'dark' ? 'gray.50' : 'gray.900'}>
            Í≤ÄÏÉâ Í≤∞Í≥º
          </Heading>
          
          {/* Í≤ÄÏÉâ ÏûÖÎ†• */}
          <HStack spacing={3} maxW="600px">
            <InputGroup size="lg">
              <InputLeftElement pointerEvents="none">
                <SearchIcon color="gray.400" />
              </InputLeftElement>
              <Input
                value={searchInput}
                onChange={(e) => setSearchInput(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="ÌÇ§ÏõåÎìúÎ°ú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî"
                bg={colorMode === 'dark' ? 'gray.800' : 'white'}
                border="2px"
                borderColor={colorMode === 'dark' ? 'brand.400' : 'brand.200'}
                _focus={{
                  borderColor: 'brand.500',
                  shadow: '0 0 0 1px var(--chakra-colors-brand-500)'
                }}
                _hover={{
                  borderColor: colorMode === 'dark' ? 'brand.300' : 'brand.300'
                }}
              />
            </InputGroup>
            <Button 
              colorScheme="brand" 
              size="lg"
              onClick={() => handleSearch(searchInput)}
            >
              Í≤ÄÏÉâ
            </Button>
          </HStack>

          {query && (
            <HStack spacing={2} flexWrap="wrap">
              <Text color={colorMode === 'dark' ? 'gray.300' : 'gray.600'}>
                "{query}"Ïóê ÎåÄÌïú Í≤ÄÏÉâ Í≤∞Í≥º
              </Text>
              <Badge colorScheme="brand" variant="subtle">
                Ï¥ù {searchResults.total}Í∞ú
              </Badge>
            </HStack>
          )}
        </VStack>

        <Divider />

        {/* Í≤ÄÏÉâ Í≤∞Í≥º ÌÉ≠ */}
        {query && (
          <Tabs index={tabIndex} onChange={setTabIndex} colorScheme="brand">
            <TabList>
              <Tab>
                Ï†ÑÏ≤¥ ({searchResults.total})
              </Tab>
              <Tab>
                Story ({searchResults.stories.length})
              </Tab>
              <Tab>
                Lounge ({searchResults.loungePosts.length})
              </Tab>
            </TabList>

            <TabPanels>
              {/* Ï†ÑÏ≤¥ ÌÉ≠ */}
              <TabPanel px={0}>
                <VStack spacing={8} align="stretch">
                  {isLoading ? (
                    <Box textAlign="center" py={8}>
                      <Text>Í≤ÄÏÉâ Ï§ë...</Text>
                    </Box>
                  ) : searchResults.total === 0 ? (
                    <EmptyState
                      title="Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏñ¥Ïöî"
                      description="Îã§Î•∏ ÌÇ§ÏõåÎìúÎ°ú Í≤ÄÏÉâÌï¥Î≥¥ÏãúÍ±∞ÎÇò Ï≤†ÏûêÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."
                    />
                  ) : (
                    <>
                      {/* Story Í≤∞Í≥º */}
                      {searchResults.stories.length > 0 && (
                        <VStack spacing={4} align="stretch">
                          <HStack justify="space-between">
                            <Heading as="h2" size="md" color={colorMode === 'dark' ? 'gray.100' : 'gray.900'}>
                              Story Í≤∞Í≥º ({searchResults.stories.length}Í∞ú)
                            </Heading>
                            {searchResults.stories.length > 6 && (
                              <Button 
                                variant="ghost" 
                                size="sm" 
                                onClick={() => setTabIndex(1)}
                              >
                                Îçî Î≥¥Í∏∞ ‚Üí
                              </Button>
                            )}
                          </HStack>
                          <SimpleGrid columns={{ base: 1, md: 2, lg: 3 }} spacing={6}>
                            {searchResults.stories.slice(0, 6).map((story) => (
                              <Card
                                key={story.id}
                                type="story"
                                id={story.id}
                                title={story.title}
                                summary={story.summary}
                                imageUrl={story.image_url}
                                tags={story.tags}
                                createdAt={story.created_at}
                                readTime={story.read_time}
                                author={story.author_name}
                                authorId={story.author_id}
                                authorVerified={story.author_verified}
                              />
                            ))}
                          </SimpleGrid>
                        </VStack>
                      )}

                      {/* Lounge Í≤∞Í≥º */}
                      {searchResults.loungePosts.length > 0 && (
                        <VStack spacing={4} align="stretch">
                          <HStack justify="space-between">
                            <Heading as="h2" size="md" color={colorMode === 'dark' ? 'gray.100' : 'gray.900'}>
                              Lounge Í≤∞Í≥º ({searchResults.loungePosts.length}Í∞ú)
                            </Heading>
                            {searchResults.loungePosts.length > 6 && (
                              <Button 
                                variant="ghost" 
                                size="sm" 
                                onClick={() => setTabIndex(2)}
                              >
                                Îçî Î≥¥Í∏∞ ‚Üí
                              </Button>
                            )}
                          </HStack>
                          <SimpleGrid columns={{ base: 1, md: 2, lg: 3 }} spacing={6}>
                            {searchResults.loungePosts.slice(0, 6).map((post) => (
                              <Card
                                key={post.id}
                                type="lounge"
                                id={post.id}
                                title={post.title}
                                summary={post.content}
                                tags={post.tags}
                                createdAt={post.created_at}
                                loungeType={post.type}
                                isExcellent={post.is_excellent}
                                likeCount={post.like_count}
                                commentCount={post.comment_count}
                                scrapCount={post.scrap_count}
                                author={post.author_name}
                                authorId={post.author_id}
                                authorVerified={post.author_verified}
                              />
                            ))}
                          </SimpleGrid>
                        </VStack>
                      )}
                    </>
                  )}
                </VStack>
              </TabPanel>

              {/* Story ÌÉ≠ */}
              <TabPanel px={0}>
                {isLoading ? (
                  <Box textAlign="center" py={8}>
                    <Text>Í≤ÄÏÉâ Ï§ë...</Text>
                  </Box>
                ) : searchResults.stories.length === 0 ? (
                  <EmptyState
                    title="Story Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏñ¥Ïöî"
                    description="Îã§Î•∏ ÌÇ§ÏõåÎìúÎ°ú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî."
                  />
                ) : (
                  <SimpleGrid columns={{ base: 1, md: 2, lg: 3 }} spacing={6}>
                    {searchResults.stories.map((story) => (
                      <Card
                        key={story.id}
                        type="story"
                        id={story.id}
                        title={story.title}
                        summary={story.summary}
                        imageUrl={story.image_url}
                        tags={story.tags}
                        createdAt={story.created_at}
                        readTime={story.read_time}
                        author={story.author_name}
                        authorId={story.author_id}
                        authorVerified={story.author_verified}
                      />
                    ))}
                  </SimpleGrid>
                )}
              </TabPanel>

              {/* Lounge ÌÉ≠ */}
              <TabPanel px={0}>
                {isLoading ? (
                  <Box textAlign="center" py={8}>
                    <Text>Í≤ÄÏÉâ Ï§ë...</Text>
                  </Box>
                ) : searchResults.loungePosts.length === 0 ? (
                  <EmptyState
                    title="Lounge Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏñ¥Ïöî"
                    description="Îã§Î•∏ ÌÇ§ÏõåÎìúÎ°ú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî."
                  />
                ) : (
                  <SimpleGrid columns={{ base: 1, md: 2, lg: 3 }} spacing={6}>
                    {searchResults.loungePosts.map((post) => (
                      <Card
                        key={post.id}
                        type="lounge"
                        id={post.id}
                        title={post.title}
                        summary={post.content}
                        tags={post.tags}
                        createdAt={post.created_at}
                        loungeType={post.type}
                        isExcellent={post.is_excellent}
                        likeCount={post.like_count}
                        commentCount={post.comment_count}
                        scrapCount={post.scrap_count}
                        author={post.author_name}
                        authorId={post.author_id}
                        authorVerified={post.author_verified}
                      />
                    ))}
                  </SimpleGrid>
                )}
              </TabPanel>
            </TabPanels>
          </Tabs>
        )}

        {/* Í≤ÄÏÉâÏñ¥Í∞Ä ÏóÜÏùÑ Îïå */}
        {!query && (
          <VStack spacing={8} align="stretch">
            {/* ÏµúÍ∑º Ìï´Ìïú ÌÇ§ÏõåÎìú */}
            {hotKeywords.length > 0 && (
              <Box>
                <Heading as="h2" size="md" mb={4} color={colorMode === 'dark' ? 'gray.100' : 'gray.900'}>
                  üî• ÏµúÍ∑º Ìï´Ìïú ÌÇ§ÏõåÎìú Top 5
                </Heading>
                <VStack spacing={3} align="stretch">
                  {hotKeywords.map((item, index) => (
                    <Flex
                      key={item.term}
                      align="center"
                      justify="space-between"
                      p={4}
                      borderRadius="lg"
                      bg={colorMode === 'dark' ? 'gray.800' : 'brand.50'}
                      border="1px"
                      borderColor={colorMode === 'dark' ? 'gray.700' : 'brand.100'}
                      _hover={{
                        bg: colorMode === 'dark' ? 'gray.700' : 'brand.100',
                        borderColor: colorMode === 'dark' ? 'brand.400' : 'brand.200',
                        cursor: 'pointer'
                      }}
                      onClick={() => {
                        handleSearch(item.term);
                      }}
                      transition="all 0.2s"
                    >
                      <HStack spacing={3}>
                        <Badge
                          colorScheme={index < 3 ? 'brand' : 'gray'}
                          variant="solid"
                          fontSize="sm"
                          minW="28px"
                          textAlign="center"
                        >
                          {item.rank}
                        </Badge>
                        <Text fontWeight="600" fontSize="lg" color={colorMode === 'dark' ? 'gray.100' : 'gray.800'}>
                          {item.term}
                        </Text>
                      </HStack>
                      <Text
                        fontSize="sm"
                        color={colorMode === 'dark' ? 'gray.400' : 'gray.500'}
                        fontWeight="500"
                      >
                        {item.count}Ìöå Í≤ÄÏÉâ
                      </Text>
                    </Flex>
                  ))}
                </VStack>
              </Box>
            )}
            
            {/* ÏµúÍ∑º Í≤ÄÏÉâÏñ¥ */}
            {recentKeywords.length > 0 && (
              <Box>
                <Heading as="h2" size="md" mb={4} color={colorMode === 'dark' ? 'gray.100' : 'gray.900'}>
                  üîç ÏµúÍ∑º Í≤ÄÏÉâÏñ¥
                </Heading>
                <Flex flexWrap="wrap" gap={3}>
                  {recentKeywords.map((term, index) => (
                    <Badge
                      key={index}
                      variant="outline"
                      colorScheme="gray"
                      fontSize="md"
                      px={4}
                      py={2}
                      borderRadius="full"
                      cursor="pointer"
                      _hover={{
                        bg: colorMode === 'dark' ? 'gray.700' : 'gray.100',
                        borderColor: colorMode === 'dark' ? 'brand.400' : 'brand.300'
                      }}
                      onClick={() => {
                        handleSearch(term);
                      }}
                    >
                      {term}
                    </Badge>
                  ))}
                </Flex>
              </Box>
            )}
            
            {/* Í∏∞Î≥∏ Î©îÏãúÏßÄ */}
            {hotKeywords.length === 0 && recentKeywords.length === 0 && (
              <Box textAlign="center" py={12}>
                <Text fontSize="lg" color={colorMode === 'dark' ? 'gray.300' : 'gray.600'}>
                  Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî
                </Text>
                <Text fontSize="md" color={colorMode === 'dark' ? 'gray.400' : 'gray.500'} mt={2}>
                  StoryÏôÄ LoungeÏùò Î™®Îì† Í∏ÄÏùÑ Í≤ÄÏÉâÌï† Ïàò ÏûàÏñ¥Ïöî
                </Text>
              </Box>
            )}
          </VStack>
        )}
      </VStack>
    </Container>
  );
};

export default SearchResults;